image: haskell:8.6.3

.variables: &stack_vars
  STACK_ROOT: ${CI_PROJECT_DIR}/.stack-root
  STACK_WORK: ${PACKAGE}/.stack-work
  STACK: >-
    stack
    --resolver=${RESOLVER}
    --no-terminal
    --stack-root ${CI_PROJECT_DIR}/.stack-root
    --work-dir .stack-work
  COVERAGE_DIR: ${CI_PROJECT_DIR}/coverage/${PACKAGE}

.stack_build: &stack_build
  before_script:
    - mkdir -p ${STACK_ROOT}
    - cd ${PACKAGE}
    - ${STACK} --install-ghc test --only-dependencies
  script:
    - ${STACK} test --coverage
  after_script:
    - mkdir -p ${COVERAGE_DIR} ${BIN_DIR}
    - cd ${PACKAGE}
    - mv `${STACK} path --local-hpc-root`/* ${COVERAGE_DIR}
  cache:
    key: ${RESOLVER}
    paths:
      - ${STACK_ROOT}
      - ${STACK_WORK}
  artifacts:
    paths:
      - ${COVERAGE_DIR}


.cabal_build: &cabal_build
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends software-properties-common
    - apt-add-repository ppa:hvr/ghc
    - apt-get update && apt-get install -y --no-install-recommends ghc-${GHC_VERSION}
    - PATH="/opt/cabal/bin:$PATH"
    - PATH="/opt/ghc/${GHC_VERSION}/bin:$PATH"
    - cabal update
    - cd ${PACKAGE}
    - cabal check
    - (cd ../${TEST_DEP}; cabal install)
    - cabal install --enable-tests --only-dependencies
  script:
    - cabal test --show-details=always
    - cabal sdist
  after_script:
    - rm -fv ${HOME}/.cabal/packages/hackage.haskell.org/build-reports.log
    # remove files that are regenerated by 'cabal update'
    - rm -fv ${HOME}/.cabal/packages/hackage.haskell.org/00-index.*
    - rm -fv ${HOME}/.cabal/packages/hackage.haskell.org/*.json
    - rm -fv ${HOME}/.cabal/packages/hackage.haskell.org/01-index.cache
    - rm -fv ${HOME}/.cabal/packages/hackage.haskell.org/01-index.tar
    - rm -fv ${HOME}/.cabal/packages/hackage.haskell.org/01-index.tar.idx
    - rm -rfv ${HOME}/.cabal/packages/head.hackage
  cache:
    key: ${GHC_VERSION}
    paths:
      - ${HOME}/.cabal/packages
      - ${HOME}/.cabal/store


lts-9.19_attoparsec-varword:
  <<: *stack_build
  variables:
    PACKAGE: attoparsec-varword
    RESOLVER: lts-9.19
    <<: *stack_vars

lts-9.19_bytestring-builder-varword:
  <<: *stack_build
  variables:
    PACKAGE: bytestring-builder-varword
    RESOLVER: lts-9.19
    <<: *stack_vars


lts-12.11_attoparsec-varword:
  <<: *stack_build
  variables:
    PACKAGE: attoparsec-varword
    RESOLVER: lts-12.11
    <<: *stack_vars

lts-12.11_bytestring-builder-varword:
  <<: *stack_build
  variables:
    PACKAGE: bytestring-builder-varword
    RESOLVER: lts-12.11
    <<: *stack_vars


ghc-8.0.2_attoparsec-varword:
  <<: *cabal_build
  variables:
    PACKAGE: attoparsec-varword
    GHC_VERSION: 8.0.2
    TEST_DEP: bytestring-builder-varword

ghc-8.0.2_bytestring-builder-varword:
  <<: *cabal_build
  variables:
    PACKAGE: bytestring-builder-varword
    GHC_VERSION: 8.0.2
    TEST_DEP: attoparsec-varword


ghc-8.2.2_attoparsec-varword:
  <<: *cabal_build
  variables:
    PACKAGE: attoparsec-varword
    GHC_VERSION: 8.2.2
    TEST_DEP: bytestring-builder-varword

ghc-8.2.2_bytestring-builder-varword:
  <<: *cabal_build
  variables:
    PACKAGE: bytestring-builder-varword
    GHC_VERSION: 8.2.2
    TEST_DEP: attoparsec-varword


ghc-8.4.2_attoparsec-varword:
  <<: *cabal_build
  variables:
    PACKAGE: attoparsec-varword
    GHC_VERSION: 8.4.2
    TEST_DEP: bytestring-builder-varword

ghc-8.4.2_bytestring-builder-varword:
  <<: *cabal_build
  variables:
    PACKAGE: bytestring-builder-varword
    GHC_VERSION: 8.4.2
    TEST_DEP: attoparsec-varword


pages:
  stage: deploy
  dependencies:
    - lts-12.11_attoparsec-varword
    - lts-12.11_bytestring-builder-varword
  script:
    - mv coverage/ public/
    - cp index.html public/
  artifacts:
    paths:
      - public
    expire_in: 3 hours
  only:
    - master
